# Deno Deploy Specification

## Overview
Deno Deploy is a globally distributed serverless platform for deploying JavaScript and TypeScript applications at the edge. It runs on Deno runtime and provides automatic scaling, zero-config deployments, and global distribution.

## Key Features

### Edge Deployment
- **Global Distribution** - Deploy to 35+ regions worldwide
- **Low Latency** - Serve users from the nearest edge location
- **Automatic Scaling** - Scale from 0 to millions of requests

### Zero Configuration
- No infrastructure management
- Automatic HTTPS
- Built-in CDN
- Environment variable management

### Deno Runtime
- Full Deno API support
- TypeScript out of the box
- Secure by default
- Web standard APIs

## Deployment Methods

### 1. GitHub Integration (Recommended)

#### Automatic Deployments
1. Push code to GitHub repository
2. Connect repo to Deno Deploy
3. Auto-deploys on push to specified branch

#### Configuration
```json
// deno.json
{
  "tasks": {
    "build": "deno task build:sveltekit"
  }
}
```

### 2. deployctl CLI

#### Install
```bash
deno install -A --no-check -r -f https://deno.land/x/deploy/deployctl.ts
```

#### Deploy
```bash
deployctl deploy --project=my-project main.ts
```

### 3. GitHub Actions (Implemented)

```yaml
# .github/workflows/deploy.yml
name: Deploy to Deno Deploy

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - uses: actions/checkout@v4

      - uses: denoland/setup-deno@v2
        with:
          deno-version: v2.x

      - name: Install dependencies
        run: deno install

      - name: Build
        run: deno task build

      - name: Deploy to Deno Deploy
        uses: denoland/deployctl@v1
        with:
          project: eric-website
          entrypoint: .deno-deploy/server.ts
```

## SvelteKit Adapter (Implemented)

### Installation
```bash
deno install -D npm:@deno/svelte-adapter
```

### Configuration
```javascript
// svelte.config.js
import adapter from "@deno/svelte-adapter";
import { vitePreprocess } from '@sveltejs/vite-plugin-svelte';

/** @type {import('@sveltejs/kit').Config} */
const config = {
  preprocess: vitePreprocess(),

  kit: {
    adapter: adapter()
  }
};

export default config;
```

### Build for Deployment
```bash
deno task build
```

This generates a `.deno-deploy/` directory with:
- `server.ts` - Server entry point
- Static assets
- Prerendered pages

## Environment Variables

### Setting Variables

#### Via Dashboard
1. Go to project settings
2. Navigate to "Environment Variables"
3. Add key-value pairs

#### Via deployctl
```bash
deployctl deploy --env=API_KEY=secret --env=DB_URL=postgres://...
```

### Accessing Variables

```typescript
// Server-side
const apiKey = Deno.env.get("API_KEY");

// Client-side (must use PUBLIC_ prefix)
const publicKey = Deno.env.get("PUBLIC_API_KEY");
```

```svelte
<!-- In SvelteKit -->
<script>
  import { env } from '$env/dynamic/public';
  const apiUrl = env.PUBLIC_API_URL;
</script>
```

## Project Structure

### Entry Point
Deno Deploy needs an entry point that exports a `fetch` handler:

```typescript
// main.ts
export default {
  async fetch(request: Request): Promise<Response> {
    return new Response("Hello from Deno Deploy!");
  }
};

// Or use Deno.serve
Deno.serve((req) => {
  return new Response("Hello!");
});
```

### SvelteKit Entry Point
After building, the entry point is `build/index.js`:

```javascript
// Generated by adapter-deno
import { Server } from './server/index.js';
import { manifest } from './server/manifest.js';

const server = new Server(manifest);

export default {
  fetch: server.respond.bind(server)
};
```

## Performance Optimization

### 1. Prerendering
Enable prerendering for static pages:

```typescript
// +page.ts
export const prerender = true;
```

### 2. Compression
Enable precompression in adapter:

```javascript
adapter: adapter({
  precompress: true  // Generates .gz and .br files
})
```

### 3. Caching Headers
```typescript
// +server.ts
export const GET = async () => {
  return new Response(data, {
    headers: {
      'cache-control': 'public, max-age=3600'
    }
  });
};
```

### 4. Edge Caching
```typescript
export const GET = async () => {
  return new Response(data, {
    headers: {
      'cache-control': 'public, max-age=3600, s-maxage=3600'
    }
  });
};
```

## Limits & Quotas

### Free Tier
- 100,000 requests/day
- 100 GiB data transfer/month
- 1 million function executions/month
- 50ms CPU time/request

### Pro Tier
- 10 million requests/month
- 100 GiB data transfer/month
- 100 million function executions/month
- 50ms CPU time/request

### Request Limits
- Request timeout: 60 seconds
- Response body: No limit
- Request body: 10 MB

## Database Integration

### KV (Built-in Key-Value Store)
```typescript
const kv = await Deno.openKv();

// Set value
await kv.set(["users", "123"], { name: "Eric" });

// Get value
const entry = await kv.get(["users", "123"]);
console.log(entry.value);

// List keys
for await (const entry of kv.list({ prefix: ["users"] })) {
  console.log(entry.key, entry.value);
}
```

### External Databases
Connect to any database via HTTP/WebSocket:

```typescript
// Supabase
import { createClient } from 'npm:@supabase/supabase-js@2';

const supabase = createClient(
  Deno.env.get('SUPABASE_URL')!,
  Deno.env.get('SUPABASE_KEY')!
);

// Neon Postgres
import { neon } from 'npm:@neondatabase/serverless';

const sql = neon(Deno.env.get('DATABASE_URL')!);
const rows = await sql`SELECT * FROM users`;
```

## Static Assets

### Serving Static Files
SvelteKit adapter handles this automatically:

```
build/
├── client/          # Static assets
│   ├── _app/       # JS/CSS bundles
│   └── favicon.png
└── server/         # Server code
```

### Custom Static Files
```typescript
// Place in static/ directory
static/
├── favicon.svg
├── robots.txt
└── images/
    └── logo.png
```

Access at root: `/favicon.svg`, `/robots.txt`, `/images/logo.png`

## Custom Domains

### Adding a Domain
1. Go to project settings
2. Add custom domain
3. Update DNS records:
   - CNAME record pointing to `cname.deno.dev`
   - Or A record to Deno Deploy IP

### HTTPS
- Automatic HTTPS with Let's Encrypt
- Certificate renewal handled automatically
- HTTP to HTTPS redirect enabled by default

## Monitoring & Logs

### View Logs
```bash
deployctl logs --project=my-project
```

### In Dashboard
- Real-time request logs
- Error tracking
- Performance metrics
- Request analytics

### Custom Logging
```typescript
console.log('Info message');
console.error('Error message');
console.warn('Warning message');
```

## Best Practices

### 1. Environment Variables
- Use `PUBLIC_` prefix for client-side variables
- Never commit secrets to Git
- Use different variables per environment

### 2. Cold Starts
- Keep dependencies minimal
- Use dynamic imports for heavy modules
- Optimize bundle size

### 3. Error Handling
```typescript
export const GET = async () => {
  try {
    const data = await fetchData();
    return json(data);
  } catch (error) {
    console.error('Error:', error);
    return json({ error: 'Internal server error' }, { status: 500 });
  }
};
```

### 4. CORS
```typescript
const headers = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
  'Access-Control-Allow-Headers': 'Content-Type'
};

export const OPTIONS = () => {
  return new Response(null, { headers });
};
```

### 5. Streaming Responses
```typescript
export const GET = async () => {
  const stream = new ReadableStream({
    async start(controller) {
      for (let i = 0; i < 10; i++) {
        controller.enqueue(`data: ${i}\n\n`);
        await new Promise(resolve => setTimeout(resolve, 100));
      }
      controller.close();
    }
  });

  return new Response(stream, {
    headers: {
      'content-type': 'text/event-stream',
      'cache-control': 'no-cache'
    }
  });
};
```

## Testing Locally

### Run Development Server
```bash
deno task dev
```

### Test Production Build
```bash
deno task build
deno run --allow-net --allow-read --allow-env build/index.js
```

## Deployment Checklist

- [x] Configure `svelte.config.js` with Deno adapter (`@deno/svelte-adapter`)
- [ ] Set up environment variables (RESEND_API_KEY, CONTACT_EMAIL_TO, GITHUB_TOKEN in Deno Deploy dashboard)
- [x] Test build locally (`deno task build`)
- [ ] Configure custom domain (ericevans.dev)
- [x] Set up GitHub Actions CI/CD (`.github/workflows/deploy.yml`)
- [x] Enable automatic deployments (on push to main)
- [ ] Configure branch deployments (main, staging, etc.)
- [ ] Test deployment in production
- [ ] Set up monitoring and alerts
- [ ] Configure error tracking

## Troubleshooting

### Build Fails
- Check `deno.json` tasks
- Verify adapter configuration
- Check for missing dependencies

### Runtime Errors
- Check Deno Deploy logs
- Verify environment variables
- Check permissions (no `--allow-*` flags needed)

### Performance Issues
- Enable compression
- Use edge caching
- Optimize bundle size
- Check cold start time

## Resources

- Official Docs: https://deno.com/deploy/docs
- Dashboard: https://dash.deno.com
- Status Page: https://status.deno.com
- Discord: https://discord.gg/deno
- GitHub: https://github.com/denoland/deploy_feedback
